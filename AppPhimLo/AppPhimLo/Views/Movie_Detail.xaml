<!-- Movie_Detail.xaml -->
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:AppPhimLo.ViewModels"
    xmlns:models="clr-namespace:AppPhimLo.Models"
    x:Class="AppPhimLo.Views.Movie_Detail"
    x:Name="Page"
    x:DataType="vm:MovieViewModel">

    <ContentPage.Resources>
        <!-- Style hiển thị lỗi -->
        <Style x:Key="ErrorLabelStyle" TargetType="Label">
            <Setter Property="TextColor" Value="#FF6B6B"/>
            <!-- Đỏ tươi dễ đọc -->
            <Setter Property="FontAttributes" Value="Bold"/>
        </Style>

        <!-- Tiêu đề mục -->
        <Style x:Key="SectionTitle" TargetType="Label">
            <Setter Property="TextColor" Value="#FFFFFF"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="Margin" Value="0,8,0,0"/>
        </Style>

        <!-- Badge -->
        <Style x:Key="BadgeLabel" TargetType="Label">
            <Setter Property="TextColor" Value="#E5E7EB"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Margin" Value="0,4,8,0"/>
        </Style>

        <!-- Chip -->
        <Style x:Key="ChipBorder" TargetType="Border">
            <Setter Property="Stroke" Value="#555"/>
            <Setter Property="StrokeThickness" Value="1"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="StrokeShape">
                <Setter.Value>
                    <RoundRectangle CornerRadius="8"/>
                </Setter.Value>
            </Setter>
            <Setter Property="Margin" Value="4,2"/>
        </Style>

    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="12" BackgroundColor="#191b24">

            <ActivityIndicator IsRunning="{Binding IsLoading}"
                               IsVisible="{Binding IsLoading}" 
                               Color="White"/>

            <Label Text="{Binding ErrorMessage}" 
                   Style="{StaticResource ErrorLabelStyle}" />

            <VerticalStackLayout IsVisible="{Binding HasData}" Spacing="14">

                <!-- Poster -->
                <Grid>
                    <Frame HasShadow="False" Padding="0" CornerRadius="16" Margin="0,4,0,0">
                        <Grid>
                            <Image Source="{Binding Movie.PosterUrl}" Aspect="AspectFill" HeightRequest="280"/>
                            <BoxView BackgroundColor="#66000000" />
                            <VerticalStackLayout Padding="16" VerticalOptions="End" Spacing="6">
                                <Label Text="{Binding Movie.Name}" 
                                       FontAttributes="Bold" FontSize="22" TextColor="White"/>
                                <Label Text="{Binding Movie.OriginName}" 
                                       FontSize="13" TextColor="#D1D5DB"/>
                            </VerticalStackLayout>
                        </Grid>
                    </Frame>
                </Grid>

                <!-- Badge -->
                <FlexLayout Direction="Row" Wrap="Wrap" AlignItems="Center" JustifyContent="Start">
                    <Label Style="{StaticResource BadgeLabel}" Text="{Binding Movie.Year, StringFormat='Năm: {0}'}"/>
                    <Label Style="{StaticResource BadgeLabel}" Text="{Binding Movie.Quality, StringFormat='Chất lượng: {0}'}"/>
                    <Label Style="{StaticResource BadgeLabel}" Text="{Binding Movie.Language, StringFormat='Ngôn ngữ: {0}'}"/>
                    <Label Style="{StaticResource BadgeLabel}" Text="{Binding Movie.Duration, StringFormat='Thời lượng: {0}'}"/>
                    <Label Style="{StaticResource BadgeLabel}" Text="{Binding Movie.EpisodeCurrent, StringFormat='Tập hiện tại: {0}'}"/>
                    <Label Style="{StaticResource BadgeLabel}" Text="{Binding Movie.EpisodeTotal, StringFormat='Tổng tập: {0}'}"/>
                </FlexLayout>

                <!-- Trailer -->
                <Button Text="🎬 Xem Trailer"
                        IsVisible="{Binding Movie.TrailerUrl}"
                        Command="{Binding OpenTrailerCommand}"
                        CommandParameter="{Binding Movie.TrailerUrl}"
                        CornerRadius="10"
                        HeightRequest="44"
                        BackgroundColor="#2563EB"
                        TextColor="White"/>

                <!-- Mô tả -->
                <Label Style="{StaticResource SectionTitle}" Text="Tóm tắt nội dung"/>
                <Label Text="{Binding Movie.Content}"
                       FontSize="14"
                       TextColor="#E5E7EB"
                       LineBreakMode="WordWrap"
                       MaxLines="6"/>

                <!-- Thể loại -->
                <Label Style="{StaticResource SectionTitle}" Text="Thể loại"/>
                <FlexLayout BindableLayout.ItemsSource="{Binding Movie.Categories}"
                            Direction="Row" Wrap="Wrap" AlignItems="Center" JustifyContent="Start"
                            BindableLayout.ItemTemplate="{StaticResource NameChipTemplate}"/>

                <!-- Quốc gia -->
                <Label Style="{StaticResource SectionTitle}" Text="Quốc gia"/>
                <FlexLayout BindableLayout.ItemsSource="{Binding Movie.Countries}"
                            Direction="Row" Wrap="Wrap" AlignItems="Center" JustifyContent="Start"
                            BindableLayout.ItemTemplate="{StaticResource NameChipTemplate}"/>

                <!-- Diễn viên -->
                <Label Style="{StaticResource SectionTitle}" Text="Diễn viên"/>
                <FlexLayout BindableLayout.ItemsSource="{Binding Movie.Actors}"
                            Direction="Row" Wrap="Wrap" AlignItems="Center" JustifyContent="Start"
                            BindableLayout.ItemTemplate="{StaticResource TextChipTemplate}"/>

                <!-- Đạo diễn -->
                <Label Style="{StaticResource SectionTitle}" Text="Đạo diễn"/>
                <FlexLayout BindableLayout.ItemsSource="{Binding Movie.Directors}"
                            Direction="Row" Wrap="Wrap" AlignItems="Center" JustifyContent="Start"
                            BindableLayout.ItemTemplate="{StaticResource TextChipTemplate}"/>

                <!-- Danh sách tập -->
                <Label Style="{StaticResource SectionTitle}" Text="Danh sách tập"/>
                <CollectionView ItemsSource="{Binding Episodes}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:EpisodeServer">
                            <Frame Padding="12" Margin="0,6" CornerRadius="14" HasShadow="True" BackgroundColor="#1F2937">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="{Binding ServerName}" 
                                           FontAttributes="Bold" FontSize="16" 
                                           TextColor="White"/>
                                    <FlexLayout BindableLayout.ItemsSource="{Binding ServerData}"
                                                Direction="Row" Wrap="Wrap" AlignItems="Center" JustifyContent="Start">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:EpisodeData">
                                                <Border Style="{StaticResource ChipBorder}">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding Source={x:Reference Page}, Path=BindingContext.OpenEpisodeCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Label Text="{Binding Name}" FontSize="13" TextColor="#E5E7EB"/>
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </FlexLayout>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
